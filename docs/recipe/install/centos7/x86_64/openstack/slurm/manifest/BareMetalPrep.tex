%\documentclass[12pt]{article}
%\usepackage{graphicx}

\begin{section}{
\newenvironment{bash}
{\begin{quote}
	}
	{ 
	\end{quote}
}
\section[]{BareMetalPrep}

This guide uses diskimage-builder utility to build and configure OS 
images for sms node as well compute node.  Preparing images is an 
optional part of overall recipe. If user has predefined images then environment 
variable “chpc\_create\_new\_image” must be reset and path to images must be 
provided using environment variable “chpc\_image\_deploy\_kernel”, 
“chpc\_image\_deploy\_ramdisk”, “chpc\_image\_user”, and “chpc\_image\_sms”. 
In this example cloud images are build on controller node “[ctrlr]\# " 
Once images are build, they are stored at standard openHPC Path.

\begin{bash}[ctrlr]\# \texttt{\small{CHPC\_CLOUD\_IMAGE\_PATH=/opt/ohpc/admin/images/cloud/}}\end{bash}

\subsection{Install and Setup disimage-builder}

Images can be built on any supported OS. 

In this example we will install and build images on controller node, user can do same on a system independent of their production cluster. 

Install diskimage-builder and its dependencies from base OS distro

\begin{bash}[ctrlr]\# \texttt{\small{yum –y install diskimage-builder PyYAML}}\end{bash}

Install grub dependency

\begin{bash}[ctrlr]\# \texttt{\small{yum –y install parted}}\end{bash}

Diskimage-builder installed from base distro does not have group install feature. So add a patch (Note: this probably will be included into RPM and will be part of that rpm installation)

\begin{bash}[ctrlr]\# \texttt{\small{yum –y install <DIB patch>}}\end{bash}

Setup common environment for diskimage-builder

diskimage-builder, or dib, uses environment variables and elements to customize the images. For debugging purpose, we will create default user \texttt{chpc} with a password \texttt{intel8086}, with sudo privilege. These variables are used by element devuser. 

\begin{bash}[ctrlr]\# \texttt{\small{export DIB\_DEV\_USER\_USERNAME=chpc}}\end{bash}
\begin{bash}[ctrlr]\# \texttt{\small{export DIB\_DEV\_USER\_PASSWORD=intel8086}}\end{bash}
\begin{bash}[ctrlr]\# \texttt{\small{export DIB\_DEV\_USER\_PWDLESS\_SUDO=1}}\end{bash}

Now add path to custom elements which are not part of base diskimage-builder. OpenHPC provides few HPC elements. [Note: This also can be part of openHPC provided rpm for dib. In that case remove this step]

\begin{bash}[ctrlr]\# \texttt{\small{export ELEMENTS\_PATH="\$(realpath ../../dib/hpc/elements)"}}\end{bash}

Add path to HPC specific files [note: same as earlier, this too can be part of rpm package]

\begin{bash}[ctrlr]\# \texttt{\small{export DIB\_HPC\_FILE\_PATH="\$(realpath ../../dib/hpc/hpc-files/)"}}\end{bash}

HPC elements are common for OpenHPC and Intel HPC Orchestrator, environment variable “DIB\_HPC\_BASE” tell dib which one to pick. For OpenHPC set environment variable

\begin{bash}[ctrlr]\# \texttt{\small{export DIB\_HPC\_BASE=”ohpc”}}\end{bash}

Make sure open hpc packages is installed. ohpc\_pkg is one of the input setup earlier in this document.

\begin{bash}[ctrlr]\# \texttt{\small{ yum -y install \$\{ohpc\_pkg\}}}\end{bash}

Export same to DIB.

\begin{bash}[ctrlr]\# \texttt{\small{export DIB\_HPC\_OHPC\_PKG=\$\{ohpc\_pkg\}}}\end{bash}

Create list of HPC elements needed to build HPC images, by starting hpc-env-base. This element will setup basic hpc environment to build hpc images.

\begin{bash}[ctrlr]\# \texttt{\small{DIB\_HPC\_ELEMENTS="hpc-env-base"}}\end{bash}

Preparing ironic deploy images 

Ironic uses deploy images (aka kernel) to bootstrap the provisioning of user images. 

Unset any previous environment flag

\begin{bash}[ctrlr]\# \texttt{\small{unset DIB\_YUM\_REPO\_CONF}}\end{bash}

Git is used by some of the elements in diskimage-builder. 

\begin{bash}[ctrlr]\# \texttt{\small{yum -y install git}}\end{bash}

Create deploy images using disk-image-create cli. This will download base centos image from distro, install ironic-agent on it and create kernel and initiramfs images.

\begin{bash}[ctrlr]\# \texttt{\small{disk-image-create ironic-agent centos7 -o icloud-hpc-deploy-c7}}\end{bash}

Move deploy images to ohpc standard path.

\begin{bash}[ctrlr]\# \texttt{\small{chpc\_image\_deploy\_kernel="\$( realpath icloud-hpc-deploy-c7.kernel)"}}\end{bash}
\begin{bash}[ctrlr]\# \texttt{\small{chpc\_image\_deploy\_ramdisk="\$( realpath icloud-hpc-deploy-c7.initramfs)"}}\end{bash}

 \#Store Images file

\begin{bash}[ctrlr]\# \texttt{\small{ mkdir -p \$CHPC\_CLOUD\_IMAGE\_PATH/}}\end{bash}
\begin{bash}[ctrlr]\# \texttt{\small{ sudo mv -f \$chpc\_image\_deploy\_kernel \$CHPC\_CLOUD\_IMAGE\_PATH/}}\end{bash}
\begin{bash}[ctrlr]\# \texttt{\small{ chpc\_image\_deploy\_kernel=\$CHPC\_CLOUD\_IMAGE\_PATH/\$(basename \$chpc\_image\_deploy\_kernel)}}\end{bash}
\begin{bash}[ctrlr]\# \texttt{\small{ sudo mv -f \$chpc\_image\_deploy\_ramdisk \$CHPC\_CLOUD\_IMAGE\_PATH/}}\end{bash}
\begin{bash}[ctrlr]\# \texttt{\small{ chpc\_image\_deploy\_ramdisk=\$CHPC\_CLOUD\_IMAGE\_PATH/\$(basename \$chpc\_image\_deploy\_ramdisk)}}\end{bash}

Preparing user images for bare metal instances

For “HPC as a Service” we will building 2 user images (1 for sms node and 1 for compute node) and 2 deploy images. User images we build here will be customized with OpenHPC using HPC specific elements. 


Preparing user Image for head node OS

To build head node (aka sms) images, we need to install server packages of HPC components. This is accomplished by setting image type to sms. Default image type in hpc elements is “compute”.

\begin{bash}[ctrlr]\# \texttt{\small{ export DIB\_HPC\_IMAGE\_TYPE=sms}}\end{bash}

Now enable SLURM resource manager for head node.

\begin{bash}[ctrlr]\# \texttt{\small{ DIB\_HPC\_ELEMENTS+=" hpc-slurm"}}\end{bash}

Add optional OpenHPC Components

\begin{bash}[ctrlr]\# \texttt{\small{if [[ \$\{enable\_mrsh\} -eq 1 ]];then}}\end{bash}
\begin{bash}[ctrlr]\# \texttt{\small{       DIB\_HPC\_ELEMENTS+=" hpc-mrsh"}}\end{bash}
\begin{bash}[ctrlr]\# \texttt{\small{fi}}\end{bash}

We will also setup HPC development environment on HPC head node. 

Enable gnu compiler

\begin{bash}[ctrlr]\# \texttt{\small{export DIB\_HPC\_COMPILER="gnu"}}\end{bash}

Enable openmpi \& mvapich2

\begin{bash}[ctrlr]\# \texttt{\small{export DIB\_HPC\_MPI="openmpi mvapich2"}}\end{bash}

Enable performance tools

\begin{bash}[ctrlr]\# \texttt{\small{export DIB\_HPC\_PERF\_TOOLS="perf-tools"}}\end{bash}

Enable 3rd party libraries serial-libs, parallel-libs, io-libs, python-libs and runtimes

\begin{bash}[ctrlr]\# \texttt{\small{export DIB\_HPC\_3RD\_LIBS="serial-libs parallel-libs io-libs python-libs runtimes"}}\end{bash}

Add hpc development environment element to list of elements

\begin{bash}[ctrlr]\# \texttt{\small{DIB\_HPC\_ELEMENTS+=" hpc-dev-env"}}\end{bash}

Now create a sms image with element local-config, dhcp-all-interfaces, devuser, selinux-permisive and all hpc specific elements. Element local-config copies your local environment into image, which is the local users, their password and permissions. Element devuser will create new user specified by environment variable “DIB\_DEV\_USER\_USERNAME”. 

\begin{bash}[ctrlr]\# \texttt{\small{disk-image-create centos7 vm local-config dhcp-all-interfaces devuser selinux-permissive \$DIB\_HPC\_ELEMENTS -o icloud-hpc-cent7-sms}}\end{bash}

It will take a while to build an image. Once image is built copy it to standard openHPC path.

\begin{bash}[ctrlr]\# \texttt{\small{chpc\_image\_sms="\$(realpath icloud-hpc-cent7.qcow2)"}}\end{bash}
\begin{bash}[ctrlr]\# \texttt{\small{mkdir -p \$CHPC\_CLOUD\_IMAGE\_PATH}}\end{bash}
\begin{bash}[ctrlr]\# \texttt{\small{mv -f \$chpc\_image\_sms \$CHPC\_CLOUD\_IMAGE\_PATH}}\end{bash}
\begin{bash}[ctrlr]\# \texttt{\small{chpc\_image\_sms=\$CHPC\_CLOUD\_IMAGE\_PATH/\$(basename \$chpc\_image\_sms)}}\end{bash}

Preparing user image for compute node OS

To build compute node images, we need to install client packages of HPC components. This is accomplished by setting image type to compute. Default image type in hpc elements is “compute”.

\begin{bash}[ctrlr]\# \texttt{\small{export DIB\_HPC\_IMAGE\_TYPE=compute}}\end{bash}

Now enable SLURM resource manager for compute node.

\begin{bash}[ctrlr]\# \texttt{\small{DIB\_HPC\_ELEMENTS+=" hpc-slurm"}}\end{bash}

Add optional OpenHPC Components

\begin{bash}[ctrlr]\# \texttt{\small{if [[ \$\{enable\_mrsh\} -eq 1 ]];then}}\end{bash}
\begin{bash}[ctrlr]\# \texttt{\small{       DIB\_HPC\_ELEMENTS+=" hpc-mrsh"}}\end{bash}
\begin{bash}[ctrlr]\# \texttt{\small{fi}}\end{bash}

Now create a compute node image with element local-config, dhcp-all-interfaces, devuser, selinux-permisive and all hpc specific elements. Element local-config copies your local environment into image, which is the local users, their password and permissions. Element devuser will create new user specified by environment variable “DIB\_DEV\_USER\_USERNAME”. 

\begin{bash}[ctrlr]\# \texttt{\small{disk-image-create centos7 vm local-config dhcp-all-interfaces devuser selinux-permissive \$DIB\_HPC\_ELEMENTS -o icloud-hpc-cent7-sms}}\end{bash}

It will take a while to build an image. Once image is built copy it to standard OpenHPC path.

\begin{bash}[ctrlr]\# \texttt{\small{chpc\_image\_sms="\$( realpath icloud-hpc-cent7.qcow2)"}}\end{bash}
\begin{bash}[ctrlr]\# \texttt{\small{mkdir -p \$CHPC\_CLOUD\_IMAGE\_PATH}}\end{bash}
\begin{bash}[ctrlr]\# \texttt{\small{mv -f \$chpc\_image\_user\$CHPC\_CLOUD\_IMAGE\_PATH}}\end{bash}
\begin{bash}[ctrlr]\# \texttt{\small{chpc\_image\_user=\$CHPC\_CLOUD\_IMAGE\_PATH/\$(basename \$chpc\_image\_sms)}}\end{bash}




\subsection{Introduction to diskimage-builder}

It is a utility to build and configure OS images for sms node as well compute node. It uses prebuild minimum OS images from base distro, which it further customizes as per user request. Diskimage-builder is a framework which uses many elements (similar to plug-ins) to customize the image. Base distribution of diskimage-builder comes with pre-defined elements. This recipe uses additional HPC elements which were built to customize images based on OpenHPC components.

HPC Elements to build OpenHPC Images

“HPC as a service” uses 4 HPC specific elements in addition to pre-packaged elements comes with diskimage-builder.
Hpc-dev-env: This is mainly used to create sms images to create HPC development environment. It creates hpc development environment by installing following OpenHPC components within image: 
	ohpc-autotools, valgrind-ohpc, easybuild-ohpc, spack-ohpc, R\_base-ohpc
	mpi and compiler for chosen MPI \& compiler via environment variable, \$DIB\_HPC\_COMPILER, DIB\_HPC\_MPI
	Performance Tools lmod-default with their 3rd party libraries.
Hpc-env-base: 
Hpc-mrsh
Hpc-slurm
Editing HPC Elements
}
%\end{document}
\end{section}
