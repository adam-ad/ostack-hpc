#!./common/bats/bin/bats
# -*-sh-*-

load ./common/test_helper_functions || exit 1
source ./common/functions || exit 1
source ./common/TEST_ENV

if [ -s ./LOCAL_ENV ];then
    source ./LOCAL_ENV
else
    ERROR "missing LOCAL_ENV"
fi

# $ID will be set to sles or centos
source /etc/os-release

containsElement () {
  local e
  for e in "${@:2}"; do [[ "$e" =~ "$1" ]] && return 0; done
  return 1
}

@test "[$TEST_DIR] verify contents of slurm-sql exist" {
    if [ "x$ID" = "xcentos" ] ||  [ "x$ID" = "xrhel" ]; then
        TEMP=$(mktemp)
        # [root@master4-centos71 tests]# repoquery --list slurm-sql${DELIM}
        # /usr/lib64/slurm
        # /usr/lib64/slurm/accounting_storage_mysql.so
        # /usr/lib64/slurm/jobcomp_mysql.so
        run bash -c "/bin/repoquery --list slurm-sql${DELIM} 2>&1 | /bin/tee $TEMP"
        cat $TEMP
#        [[ ${lines[1]} =~ "accounting_storage_mysql.so" ]]
#        [[ ${lines[2]} =~ "jobcomp_mysql.so" ]]
        containsElement "accounting_storage_mysql.so" "${lines[@]}"
        containsElement "jobcomp_mysql.so" "${lines[@]}"
    elif [ "x$ID" = "xsles" ]; then
        TEMP=$(mktemp)
        export XDG_CACHE_HOME="$(mktemp -d)"
        # Fetch the files without installing:
        zypper download slurm-sql${DELIM}
        # List the files in an uninstalled package:
        # /tmp/zypp/packages/*/x86_64/slurm-sql${DELIM}-*.x86_64.rpm
        run bash -c "rpm -qlp $XDG_CACHE_HOME/zypp/packages/*/x86_64/slurm-sql-*.rpm 2>&1 | /usr/bin/tee $TEMP"
        cat $TEMP
#        [[ ${lines[1]} =~ "accounting_storage_mysql.so" ]]
#        [[ ${lines[2]} =~ "jobcomp_mysql.so" ]]
        containsElement "accounting_storage_mysql.so" "${lines[@]}"
        containsElement "jobcomp_mysql.so" "${lines[@]}"
    else
        flunk "test designed for rhel/centos or sles."
    fi
}
